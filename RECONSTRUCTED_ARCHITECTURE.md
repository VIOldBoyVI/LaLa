# LaLaGame - Полная реконструкция архитектуры

## Обзор проекта

LaLaGame - это веб-игра-викторина с элементами караоке, выполненная в виде веб-приложения с интерактивным полем 10×10, где игроки открывают ячейки, отвечают на вопросы и зарабатывают очки.

## Архитектурные компоненты

### 1. Backend - Flask приложение (src/app.py)

#### Основной класс: QuizGameApp

```python
class QuizGameApp:
    """
    Класс-обертка для Flask-приложения викторины
    """
    
    def __init__(self):
        self.app = Flask(__name__)
        self.app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'default_secret_key')
        CORS(self.app)  # Enable CORS for all routes
        self.DATABASE = 'database.db'
        self._setup_routes()
```

#### Методы класса:

1. **get_db_connection()** - создает соединение с базой данных с обработкой ошибок
2. **init_db()** - инициализирует базу данных, создает таблицы и заполняет начальными данными
3. **_setup_routes()** - настраивает маршруты Flask-приложения
4. **run()** - запускает Flask-приложение

#### API эндпоинты:

1. **POST /api/init_game** - инициализация новой игры
2. **POST /api/get_question** - получение вопроса для раунда
3. **POST /api/check_answer** - проверка ответа на вопрос
4. **POST /api/save_state** - сохранение состояния игры
5. **GET /api/load_state** - загрузка состояния игры

#### Структура базы данных:

```sql
-- Таблица вопросов
CREATE TABLE questions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    round_num INTEGER,
    question_text TEXT NOT NULL,
    answer TEXT NOT NULL,
    theme TEXT NOT NULL
);

-- Таблица состояний игры
CREATE TABLE game_states (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT UNIQUE NOT NULL,
    current_round INTEGER DEFAULT 1,
    current_cell TEXT,
    score INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица очков
CREATE TABLE scores (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT,
    round_num INTEGER,
    player_name TEXT,
    score INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. Frontend - HTML шаблоны

#### Структура игрового поля:
- Игровое поле 10×10 (100 ячеек)
- Буквенная адресация столбцов (A-J)
- Числовая адресация строк (1-10)
- 90 ячеек с вопросами (числа 1-90)
- 10 ячеек с символами (★, ♥, ♦, ♣, ♠, ♪, ♫, ☀, ☁, ☂)

#### Система очков:
- За правильный ответ на вопрос: +10 очков
- За символ: переход хода к следующему игроку

#### Страницы:
1. **index.html** - основная страница с оранжевой темой
2. **quiz-game.html** - альтернативная версия с синей темой
3. **quiz-game_orange.html** - оранжевая тема с другим расположением элементов

### 3. Зависимости (requirements.txt)

```
Flask==2.3.3
Flask-CORS==4.0.0
```

## Игровая механика

### Раунды:
1. **Раунд 1**: Музыкальные жанры (20 вопросов)
2. **Раунд 2**: Музыкальные исполнители (20 вопросов)
3. **Раунд 3**: Музыкальные инструменты (20 вопросов)
4. **Раунд 4**: Музыкальная история (20 вопросов)
5. **Раунд 5**: Смешанные темы (10 вопросов)

### Правила:
- Играют 2 игрока
- Игроки поочередно открывают ячейки
- При открытии ячейки с числом (вопросом) игрок отвечает на вопрос
- При правильном ответе игрок получает 10 очков
- При открытии ячейки с символом ход переходит к следующему игроку
- После 20 открытых ячеек в раундах 2 и 4 начинается 10-минутный перерыв
- Игра продолжается до открытия всех ячеек

## Кодовая структура

### Backend (Python):

1. **app.py** - основной файл приложения
   - Класс QuizGameApp
   - Инициализация базы данных
   - API эндпоинты
   - Обработка ошибок
   - CORS поддержка

2. **run.py** - файл запуска приложения
   - Инициализация и запуск Flask-приложения
   - Установка параметров запуска

### Frontend (JavaScript):

1. **Инициализация игры**:
   - Создание игрового поля 10×10
   - Генерация меток столбцов (A-J) и строк (1-10)
   - Заполнение поля случайными значениями

2. **Логика игры**:
   - Обработка кликов по ячейкам
   - Проверка типа ячейки (вопрос/символ)
   - Переключение между игроками
   - Обновление счета
   - Проверка окончания игры

## Безопасность

1. **SQL-инъекции**: Использование параметризованных запросов
2. **CORS**: Настройка кросс-доменных запросов
3. **SECRET_KEY**: Защита сессий Flask
4. **Валидация данных**: Проверка входных данных в API

## Типизация

Приложение использует аннотации типов для лучшей читаемости и поддержки кода:

```python
def get_db_connection(self) -> Optional[sqlite3.Connection]:
    ...

def init_db(self) -> None:
    ...

def _setup_routes(self) -> None:
    ...
```

## Запуск приложения

### Локальный запуск:

1. Установка зависимостей:
```bash
pip install -r requirements.txt
```

2. Запуск приложения:
```bash
python src/app.py
# или
python run.py
```

3. Открытие в браузере: http://localhost:5555

## Возможные улучшения

### Технические улучшения:
1. **Масштабируемость**: Использование ORM (SQLAlchemy) для лучшей масштабируемости
2. **Тестирование**: Добавление unit-тестов и интеграционных тестов
3. **Логирование**: Добавление системы логирования
4. **Конфигурация**: Вынесение параметров конфигурации в отдельный файл

### Функциональные улучшения:
1. **Многопользовательская игра**: Поддержка более 2 игроков
2. **Система аутентификации**: Регистрация и вход пользователей
3. **История игр**: Сохранение истории и статистики
4. **API документация**: Swagger/OpenAPI документация
5. **Мобильная версия**: Улучшенная адаптивность под мобильные устройства

## Заключение

LaLaGame представляет собой хорошо спроектированное веб-приложение-викторину с современной архитектурой. Приложение демонстрирует лучшие практики разработки Flask-приложений, включая структурированный код, обработку ошибок, безопасность и типизацию. Архитектура позволяет легко расширять функциональность и поддерживать код в долгосрочной перспективе.