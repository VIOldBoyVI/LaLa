# LaLaGame - Обзор реконструированной архитектуры

## 1. Введение

ЛА-ЛА-ГЕЙМ — это веб-приложение-викторина с элементами караоке, реализованное на Flask. Игра предоставляет интерактивное поле 8×10, где игроки открывают ячейки, отвечают на вопросы и зарабатывают очки.

## 2. Текущая архитектура

### 2.1. Структура проекта

```
/workspace/
├── app.py                 # Основное Flask-приложение
├── config.py              # Конфигурация игры, символы и вопросы
├── run.py                 # Скрипт запуска приложения
├── requirements.txt       # Зависимости Python
├── database.db            # База данных SQLite
├── templates/
│   └── index.html         # Основной HTML шаблон
├── __pycache__/           # Кэшированные Python файлы
├── test_*.py              # Тестовые файлы
├── StartLaLa.bat          # Скрипт запуска для Windows
├── server.log             # Лог-файл сервера
├── *.md                   # Документация
└── README.md              # Основная документация
```

### 2.2. Backend архитектура

**app.py** - основной файл приложения, который включает:

- Flask-маршруты для API и веб-страниц
- Функции для работы с базой данных
- Обработчики всех API-эндпоинтов
- Логику сохранения и восстановления состояния игры

**config.py** - файл конфигурации, содержащий:

- Символы для игры (эмодзи)
- Настройки игрового поля (размеры, количество ячеек)
- Стили для отображения элементов
- Все игровые вопросы (более 180 вопросов по 5 темам)

**run.py** - точка запуска приложения:

- Инициализирует базу данных
- Запускает Flask-приложение
- Управляет настройками сервера

### 2.3. Frontend архитектура

**templates/index.html** - основной шаблон с:

- Интерактивным игровым полем 8×10
- Системой отображения вопросов
- Управлением игроками
- JavaScript логикой для взаимодействия с API

## 3. API Эндпоинты

### 3.1. Игровые эндпоинты

- `GET /` - основная страница игры
- `GET /quiz` - альтернативная версия игры
- `GET /quiz-game` - третья версия игры

### 3.2. API эндпоинты

- `POST /api/init_game` - инициализация новой игры
- `POST /api/get_question` - получение вопроса
- `POST /api/check_answer` - проверка ответа
- `POST /api/save_state` - сохранение состояния
- `GET /api/load_state` - загрузка состояния
- `POST /api/mark_cell_opened` - пометка ячейки как открытой
- `GET /api/get_opened_cells` - получение открытых ячеек
- `POST /api/clear_opened_cells` - очистка открытых ячеек
- `GET /api/get_all_questions` - получение всех вопросов
- `GET /api/config` - получение конфигурации
- `POST /api/add_player` - добавление игрока
- `POST /api/update_player` - обновление игрока
- `POST /api/remove_player` - удаление игрока
- `POST /api/reset_players` - сброс игроков
- `POST /api/get_players` - получение списка игроков
- `POST /api/save_board_layout` - сохранение расклада доски

## 4. База данных

### 4.1. Структура таблиц

**questions** - содержит все игровые вопросы:
- id (INTEGER PRIMARY KEY)
- round_num (INTEGER) - номер раунда
- question_text (TEXT) - текст вопроса
- answer (TEXT) - правильный ответ
- theme (TEXT) - тема вопроса

**game_states** - содержит состояния игр:
- id (INTEGER PRIMARY KEY)
- session_id (TEXT UNIQUE) - ID сессии
- current_round (INTEGER) - текущий раунд
- current_cell (TEXT) - текущая ячейка
- score (INTEGER) - счет
- revealed_cells (TEXT) - открытые ячейки (JSON строка)
- board_state (TEXT) - состояние доски (JSON строка)
- created_at (TIMESTAMP) - время создания

**opened_cells** - содержит информацию об открытых ячейках:
- id (INTEGER PRIMARY KEY)
- session_id (TEXT) - ID сессии
- round_num (INTEGER) - номер раунда
- row_num (INTEGER) - номер строки
- col_num (INTEGER) - номер колонки
- cell_value (TEXT) - значение ячейки
- created_at (TIMESTAMP) - время создания

**players** - содержит информацию об игроках:
- id (INTEGER PRIMARY KEY)
- session_id (TEXT) - ID сессии
- player_name (TEXT) - имя игрока
- score (INTEGER) - счет
- position (INTEGER) - позиция
- created_at (TIMESTAMP) - время создания

**scores** - содержит историю очков:
- id (INTEGER PRIMARY KEY)
- session_id (TEXT) - ID сессии
- round_num (INTEGER) - номер раунда
- player_name (TEXT) - имя игрока
- score (INTEGER) - счет
- created_at (TIMESTAMP) - время создания

## 5. Игровая логика

### 5.1. Игровое поле

- Размер: 8 строк × 10 колонок = 80 ячеек
- Каждая ячейка содержит число от 1 до 80
- При клике на ячейку открывается вопрос
- Открытые ячейки сохраняются в базе данных

### 5.2. Раунды и темы

Игра состоит из 5 тематических раундов:

1. **Музыкальные жанры** - вопросы о музыкальных стилях и направлениях
2. **Музыкальные исполнители** - вопросы о музыкантах и группах
3. **Музыкальные инструменты** - вопросы о музыкальных инструментах
4. **Музыкальная история** - вопросы об истории музыки
5. **Смешанные темы** - вопросы из разных категорий

### 5.3. Система очков

- При правильном ответе игрок получает 10 очков
- Система поддерживает несколько игроков
- Возможность изменения имен и очков игроков

## 6. Сохранение состояния

### 6.1. Механизмы сохранения

- Состояние игры сохраняется в базе данных
- Расклад ячеек сохраняется и восстанавливается
- Открытые ячейки сохраняются по сессии
- Информация об игроках сохраняется

### 6.2. Управление сессиями

- Уникальный ID сессии генерируется при запуске
- ID сессии сохраняется в localStorage
- При возврате состояние восстанавливается

## 7. Безопасность

### 7.1. Защитные меры

- Использование параметризованных запросов для защиты от SQL-инъекций
- Проверка подключения к базе данных
- Обработка ошибок во всех операциях
- CORS включен для кросс-доменных запросов

### 7.2. Валидация данных

- Проверка входных данных в API-эндпоинтах
- Валидация сессии перед выполнением операций
- Обработка граничных случаев

## 8. Тестирование

### 8.1. Доступные тесты

- `test_functionality.py` - тестирование основной функциональности
- `test_board_numbers.py` - тестирование распределения номеров
- `test_board_reset.py` - тестирование сброса доски
- `final_verification.py` - финальная проверка

### 8.2. Тестируемые компоненты

- Загрузка конфигурации
- Инициализация игры
- Открытие ячеек
- Сохранение состояния
- Работа с базой данных

## 9. Запуск и эксплуатация

### 9.1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 9.2. Запуск приложения

```bash
python run.py
```

### 9.3. Доступ к приложению

Открыть в браузере: http://127.0.0.1:5555

## 10. Заключение

ЛА-ЛА-ГЕЙМ представляет собой полнофункциональное Flask-приложение с продуманной архитектурой. Приложение успешно реализует все заявленные функции викторины с элементами караоке и обеспечивает надежное сохранение состояния игры. Архитектура позволяет легко расширять функциональность и поддерживать код в будущем.